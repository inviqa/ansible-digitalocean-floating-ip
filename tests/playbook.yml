---

- hosts: digital-ocean
  connection: local
  gather_facts: false
  vars:
    enc_do_v2_api_key: "{{ lookup('env','DIGITAL_OCEAN_API_TOKEN') }}"
    do_backups_enabled: false
  roles:
  - { role: digital-ocean }

- hosts: digital-ocean
  vars:
    test_hostname: "{{ inventory_hostname }}-test-with-ansible"
    firewall_state: started
    firewall_enabled_at_boot: true
    firewall_allowed_tcp_ports:
      - "22"
      - "2222"
    firewall_additional_rules:
      - 'iptables -A PREROUTING -t nat -p tcp -m tcp --dport 2222 -m comment --comment "Test Rule: Redirect 2222 traffic to port 22" -j REDIRECT --to-ports 22'

  pre_tasks:
    - name: Update the hostname
      raw: bash -c "(hostname | grep -x {{ test_hostname }}) || hostname {{ test_hostname }}"
      register: output
      changed_when: output.stdout == ""

  roles:
  - { role: digitalocean-floating-ip}
  - { role: firewall }
  tasks:
    - include_tasks: tasks/test_tasks.yml


...
