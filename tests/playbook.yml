---

- hosts: digital-ocean
  connection: local
  gather_facts: false
  vars:
    ansible_python_interpreter: "python"
    ansible_connection: local

  roles:
    - { role: digital-ocean }

- hosts: digital-ocean
  vars:
    ansible_ssh_extra_args: '-o StrictHostKeyChecking=no'
    do_test_tag: "ANSIBLE-TEST"
    firewall_state: started
    firewall_enabled_at_boot: true
    firewall_allowed_tcp_ports:
      - "22"
      - "2222"
    firewall_additional_rules:
      - 'iptables -A PREROUTING -t nat -p tcp -m tcp --dport 2222 -m comment --comment "Test Rule: Redirect 2222 traffic to port 22" -j REDIRECT --to-ports 22'

  # pre_tasks:
  #   - name: Update the hostname
  #     raw: bash -c "(hostname | grep -x {{ hostname }}) || hostname {{ hostname }}"
  #     register: output
  #     changed_when: output.stdout == ""

  roles:
  - { role: digitalocean-floating-ip}
  - { role: firewall }
  tasks:
    - include_tasks: tasks/tag_droplets.yml
    - include_tasks: tasks/test_tasks.yml
...
